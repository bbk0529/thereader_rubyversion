<script type="text/javascript">
	$(document).ready(function() {
		// var chart =bb.generate({
		//     "bindto": "#chart",
		//     "data": {
		//         "columns": [
		//         ],
		//         "types": {
		//         	"data1": "step",
		//             "data2": "area-step"
		//         },
		//         "colors": {
		//           data1: "grey",
		//           data2: "black"
		//         }
		//     },
		//
		//     "legend": {
		//         "position": "right"
		//      },
		// 	"axis": {
		// 	    "x": {
		// 	      "type": "category",
		// 	      "categories": [
		// 	    	"Openness",
		// 	    	"Adventurousness",
		// 	    	"Artistic_interests",
		// 	    	"Emotionality",
		// 	    	"Imagination",
		// 	    	"Intellect",
		// 	    	"Authority_challenging",
		// 	    	"Conscientiousness",
		// 	    	"Achievement_striving",
		// 	    	"Cautiousness",
		// 	    	"Dutifulness",
		// 	    	"Orderliness",
		// 	    	"Self_discipline",
		// 	    	"Self_efficacy",
		// 	    	"Extraversion",
		// 	    	"Activity_level",
		// 	    	"Assertiveness",
		// 	    	"Cheerfulness",
		// 	    	"Excitement_seeking",
		// 	    	"Outgoing",
		// 	    	"Gregariousness",
		// 	    	"Agreeableness",
		// 	    	"Altruism",
		// 	    	"Cooperation",
		// 	    	"Modesty",
		// 	    	"Uncompromising",
		// 	    	"Sympathy",
		// 	    	"Trust",
		// 	    	"Emotional_range",
		// 	    	"Fiery",
		// 	    	"Prone_to_worry",
		// 	    	"Melancholy",
		// 	    	"Immoderation",
		// 	    	"Self_consciousness",
		// 	    	"Susceptible_to_stress"
		// 	      ]
		// 	    }
		//  }
		// }); // var chart







		$('#callwatson').click(function() {
			let sender=$('#sender').text();
			let date=$('#date').text();
			let text=$('#text').serialize();
			text = decodeURIComponent(text);
			watsonNLU(sender, date, text);
		})

		var num=0;
		$("input:hidden").each(function(){
	    	console.log($(this).val());
	    	num+=parseInt($(this).val());
	    });
		$("#wordcount").append("TOTAL WORDS :"+ num);
		if (num<600) {
			$("#comment").append("For better result, add more email(s) to sum up to more than 600 words");
		}
	})

	function children(data){
		var a='';
		a +="<div class='container'><div class='row'><div class='col-xs-12'>";
		a +="<table class='table'>";
		a +="<tbody>";

		a+="<table class='table'>";
		$.each(data, function(key, val) {
			if (key !='id' && key!='created_at' && key!='updated_at' && key!='sender') {
				if (val>0.9){
					a += "<tr>";
					a += "<td>" + key + "</td>";
					a += "<td>" + val + "</td>";
					a += "<td>" + barchart(val, "green") +"</td>";
					a += "</tr>";
				} else if (val>0.7) {
					a += "<tr>";
					a += "<td>" + key + "</td>";
					a += "<td>" + val + "</td>";
					a += "<td>" + barchart(val, "lgreen") +"</td>";
					a += "</tr>";
				} else {
					a += "<tr style='color:grey;'>";
					a += "<td>" + key + "</td>";
					a += "<td>" + val + "</td>";
					a += "<td>" + barchart(val, "grey") +"</td>";
					a += "</tr>";
				}
			}
		});
		a+="</table>";
		return a;
	}



		function barchart(val, color){
			var w= parseInt(val * 100);
	    if (color == 'green')  {
			  return '<img src="<%=asset_path('point_green.png')%>" height="7" width="'+ w + '"/>';
	    }
	    else if (color=='lgreen') {
	      return '<img src="<%=asset_path('point_lgreen.png')%>" height="7" width="'+ w + '"/>';
	    }
	    else {
	      return '<img src="<%=asset_path('point_grey.png')%>" height="7" width="'+ w + '"/>';
	    }
		};


			function datainput(data){
				var arr = new Array();
				$.each(data, function (key,val){
					if (key !='id' && key!='created_at' && key!='updated_at') {
						arr.push(val)
					};
				});
				console.log(arr);
				return arr;
			};


	function watsonNLU(sender, date, text){
		console.log('sender' + sender);
		console.log('date' + date);
		console.log('text' + text);
		text=encodeURI(text)
		console.log(text)

		/* //console.log('text' + text); */
		$.ajax({
			url : "/reader/watson",
			type : "get",
			data : '&sender=' + sender +'&date=' + date + '&text=' + text,
			success : function(data) {
				if(data != null) {
					var chart =bb.generate({
					    "bindto": "#chart",
					    "data": {
					        "columns": [
					        ],
					        "types": {
					        	"data1": "step",
					            "data2": "area-step"
					        },
					        "colors": {
					          data1: "grey",
					          data2: "black"
					        }
					    },

					    "legend": {
					        "position": "right"
					     },
						"axis": {
						    "x": {
						      "type": "category",
						      "categories": [
						    	"Openness",
						    	"Adventurousness",
						    	"Artistic_interests",
						    	"Emotionality",
						    	"Imagination",
						    	"Intellect",
						    	"Authority_challenging",
						    	"Conscientiousness",
						    	"Achievement_striving",
						    	"Cautiousness",
						    	"Dutifulness",
						    	"Orderliness",
						    	"Self_discipline",
						    	"Self_efficacy",
						    	"Extraversion",
						    	"Activity_level",
						    	"Assertiveness",
						    	"Cheerfulness",
						    	"Excitement_seeking",
						    	"Outgoing",
						    	"Gregariousness",
						    	"Agreeableness",
						    	"Altruism",
						    	"Cooperation",
						    	"Modesty",
						    	"Uncompromising",
						    	"Sympathy",
						    	"Trust",
						    	"Emotional_range",
						    	"Fiery",
						    	"Prone_to_worry",
						    	"Melancholy",
						    	"Immoderation",
						    	"Self_consciousness",
						    	"Susceptible_to_stress"
						      ]
						    }
					 }
					}); // var chart

					console.log(data);
					var a='';
					a=children(data);
					console.log(a);
					document.getElementById("result").innerHTML = a;
					data=datainput(data);
					chart.category(2, "Category 3");
					chart.load({
					    columns: [
					       data
					   ]
					 }); // chart.load
				} else {
					alert('data is null');
				}
			},
			error : function(request, status, error) {
				console.log("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
			}
		});
	}
</script>





<div class="row">
	 	<div class="col-sm-9 col-xs-9">
	 		<h2> A Bot Reading Emails </h2>
			<h4> Reading emails, analyzing personalities, retreiving insights for you. </h4>
	 	</div>
	 	<div class="col-sm-3 col-xs-3">
	 		<a href="/">
	 		<img src="<%= asset_path( 'title.png' ) %>" class="img-rounded" style="width:100%">
	 		</a>
	 	</div>
</div>


<div class="row">
	<div class="col-sm-12">
		<div class="row">
			<div class="col-sm-3">
				<h3>SENDER</h3>
				<p  name="sender" id="sender"><%=@email.sender%></p>
			</div>
			<div class="col-sm-2">
				<h3>DATE</h3>
				<p  name="date" id="date"><%=@email.date%></p>
			</div>
			<div class="col-sm-7">
				<h3>SUBJECT</h3>
				<p  name="subject"><%=@email.subject%></p>
				<input type="hidden" value="<%=@email.wordcount%>">
			</div>
		</div>
		<div class="row">
			<div class="col-sm-12">
				<h3>TEXT</h3>
			</div>
			<div class="form-group row">
			<div class="col-xs-12">
				<textarea class="form-control col-sm-5" id="text" name="text" rows="10" readonly><%=@email.text%></textarea>
			</div>
		</div>

		</div>
		<div class="row">
			<div class="col-lg-3 col-sm-3" id="wordcount"></div>
			<div class="col-lg-8 col-sm-9" id="comment"></div>
		</div>
	</div>
</div>
<div class="row">
			<br/><br/>
			<div class="col-sm-12" style="text-align: center">
				<button type="button" class="btn btn-primary"/ id="callwatson"> WATSON</button></>
				<a href="/"><button type="button" id="home" class="btn btn-default"/>HOME</button></a>
				<button id="submit" type="button" class="btn btn-default" onclick="javascript:history.back()"/>BACK</button>
			</div>
</div>


<div class="row">
	<div class="col-sm-12"><div id="chart"></div></div>
</div>

<div class="row">
	<div class="col-sm-10"><div id="result"></div></div>
</div>
